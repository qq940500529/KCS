# 基于 TPM 的安全密钥转换系统 (Key Conversion System) 设计文档

## 1. 项目概述

本项目旨在开发一种开源的、纯 Web 访问的密码生成与转换工具。该工具利用可信平台模块 (TPM) 硬件特性，实现高安全性的密钥管理与分享机制。系统能够生成用于文件加密的**私钥**、用于分享的**公钥**以及用于授权解密的**转换密钥**。

核心特性包括：

- **硬件绑定**：依赖服务器本地 TPM 生成核心密钥，防止异地破解。
- **时间控制**：公钥还原私钥受严格的时间窗口限制，且时间验证不依赖系统时间或 NTP，而是基于 TPM 的防篡改时钟，并内嵌于解密算法的数学逻辑中。
- **多重授权**：必须同时拥有公钥、正确的转换密钥、且在正确的服务器（硬件+URL）和正确的时间段内才能解密。

## 2. 核心概念与密钥体系

系统涉及四种类型的密钥，每种密钥都有其特定的生成方式和用途：

| 密钥名称                    | 生成方式                                   | 存储方式                         | 用途                             | 备注                                   |
| :-------------------------- | :----------------------------------------- | :------------------------------- | :------------------------------- | :------------------------------------- |
| **核心密钥 (Core Key)**     | 部署时由 TPM 基于硬件特征、URL、随机码生成 | 永存于 TPM (NV RAM 或 Key Store) | 验证解密服务身份，参与解密运算   | 不可逆推硬件特征，硬件特征不可正推密钥 |
| **私钥 (Private Key)**      | 系统随机生成 (用户定义规则)                | 用户自行保存 (用于加密文件)      | 文件加密                         | 长度 6-16 位，含大小写字母、数字、符号 |
| **转换密钥 (Transfer Key)** | 系统随机生成 (**可配置 1-5 个**)                  | **不存储**，需分享给接收者       | 公钥 -> 私钥转换的授权凭证       | **解密时必须提供所有转换密钥**，缺一不可 |
| **公钥 (Public Key)**       | 系统生成 (包含加密后的私钥信息)            | 用户分享                         | 携带私钥信息、时间限制、地址信息 | 只有满足所有条件才能还原出私钥         |

## 3. 详细功能设计

### 3.1. 系统部署与初始化 (核心密钥生成)

在工具部署时，系统执行以下初始化流程：

1.  **环境检测**：检测服务器是否存在 TPM 2.0 模块。
2.  **核心密钥检查**：检查 TPM 中是否已存在带有特定标签 (Label) 的核心密钥。
    - 若存在：提示用户复用或覆盖。
    - 若不存在或选择覆盖：进入生成流程。
3.  **核心密钥生成算法**：
    - **输入**：
      - 本地硬件特征 (如 Endorsement Key Public 部分, Platform Configuration Registers 等)。
      - 用户输入的工具可访问地址 (URL)。
      - 系统生成的随机码 (Salt)。
    - **过程**：使用 TPM 的 `TPM2_CreatePrimary` 或 `TPM2_HMAC` 功能，将上述输入混合，在 TPM 内部生成一个不可导出的密钥句柄或种子。
    - **存储**：将生成的密钥或其句柄持久化存储在 TPM 的 NV 索引中，并打上项目专属标签。
    - **特性**：
      - **单向性**：无法通过核心密钥反推硬件特征或 URL。
      - **不可复制**：核心密钥无法从 TPM 中明文导出，只能在 TPM 内部参与运算。

### 3.2. 密钥生成流程

用户在 Web 界面配置参数后，系统执行以下步骤：

1.  **生成私钥**：
    - 根据用户规则 (长度 6-16 位，字符集要求) 使用加密级随机数生成器生成**私钥** $K_{priv}$。
2.  **生成转换密钥**：
    - 随机生成 **1-5 个转换密钥** $K_{trans,1}, K_{trans,2}, ..., K_{trans,n}$（数量可配置）。
    - 每个转换密钥独立生成，具有相同的安全强度。
3.  **定义时间窗口**：
    - 确定生效时间 $T_{start}$ 和截止时间 $T_{end}$。
4.  **生成公钥 (加密封装)**：
    - **地址绑定**：将当前服务地址 URL 加密包含在公钥中。
    - **时间与密钥绑定 (数学层面)**：
      - 利用 TPM 的 **PolicyAuth** 或 **Sealing** 机制。
      - 将私钥 $K_{priv}$ 使用一个**临时主密钥** $K_{master}$ 进行加密。
      - $K_{master}$ 的生成依赖于：核心密钥、转换密钥 $K_{trans}$、以及 TPM 的时间状态。
      - **关键算法思路**：
        $$ K_{master} = \text{KDF}( \text{CoreKey}, K_{trans}, \text{TPM\_Time\_Seed} ) $$
        或者使用秘密共享方案 (Shamir's Secret Sharing)，将私钥碎片化，恢复私钥需要转换密钥和 TPM 在特定时间窗口内生成的签名。
    - **输出**：生成**公钥** $K_{pub}$，其中包含加密后的私钥密文、加密的 URL、明文/密文的时间提示信息。

### 3.3. 密钥转换 (解密) 流程

当用户持有公钥和转换密钥，在 Web 界面请求获取私钥时：

1.  **地址验证**：
    - 系统首先尝试从公钥中解密出原始 URL。
    - 若解密出的 URL 与当前访问地址不符，提示用户前往正确的服务器地址，并显示正确地址。
2.  **输入验证**：
    - 用户必须输入**所有转换密钥**（与生成时的数量一致）。
    - **安全要求**：所有转换密钥都必须正确，缺少任何一个或任何一个错误都将导致解密失败。
3.  **时间与硬件验证 (TPM 参与)**：
    - 系统调用 TPM 接口。
    - **时间检查**：读取 TPM 内部时钟/计数器。注意：此处不依赖系统 OS 时间。
    - **解密尝试**：
      - 将公钥密文、转换密钥输入到解密逻辑中。
      - 解密逻辑请求 TPM 使用核心密钥参与运算。
      - **数学层面的时间限制**：
        - 方案 A (TPM Policy)：TPM 仅在内部时钟处于 $T_{start}$ 和 $T_{end}$ 对应的 Tick 范围内时，才允许使用核心密钥进行解密或 Unseal 操作。若时间不符，TPM 拒绝操作，解密直接失败。
        - 方案 B (时间作为参数)：当前 TPM 时间读数作为解密算法的输入参数。若时间不在范围内，输入的参数错误，解出的结果将是乱码，而非私钥。
4.  **结果输出**：
    - 若所有条件 (转换密钥正确、硬件正确、时间在范围内) 均满足，系统还原并显示**私钥**。
    - 若不在时间范围内，提示具体的允许解密时间段。

## 4. 技术细节与安全性

### 4.1. 时间验证机制

- **不依赖 NTP/OS 时间**：完全依赖 TPM 的 `TPM2_GetTime` 或单调计数器。
- **防篡改**：TPM 时钟由硬件维护。即使攻击者修改了服务器的系统时间，TPM 的时钟/Tick Count 不会改变（或行为不同步），导致解密参数不匹配。
- **数学绑定**：时间不仅仅是一个 `if (now < end_time)` 的逻辑判断（容易被代码修改绕过），而是作为解密密钥派生函数 (KDF) 的一部分。
  - 例如：$Key_{decryption} = Hash(K_{trans} + TPM\_Signature(Current\_Tick))$。如果 $Current\_Tick$ 不在预设范围内，TPM 拒绝签名，或者生成的 Hash 值无法解开密文。

### 4.2. 核心密钥保护

- 核心密钥属性设置为 `TPMA_OBJECT_FIXEDTPM` (不可迁移) 和 `TPMA_OBJECT_FIXEDPARENT`。
- 即使服务器被克隆（硬盘镜像），由于新硬件的 TPM 不同，无法恢复核心密钥，从而无法解密。

### 4.3. 转换密钥的作用

- 转换密钥不在服务器存储，也不在公钥中存储。
- 它是解密方程中的未知数 $X$。没有它，即使拥有公钥和控制了服务器，也无法计算出私钥。

### 4.4. 私钥规范

- 长度：6-16 位。
- 字符集：[A-Z], [a-z], [0-9], 特殊符号。
- 验证：生成时确保符合用户设定的复杂度要求。

## 5. 开发计划

1.  **环境准备**：搭建带有 TPM 2.0 模拟器 (如 IBM TPM Simulator) 的开发环境。
2.  **后端开发**：
    - 实现 TPM 交互接口 (使用 tpm2-tss 或相关语言绑定)。
    - 实现核心密钥生成与持久化逻辑。
    - 实现基于时间的加密/解密算法。
3.  **前端开发**：
    - 密钥生成界面 (参数配置、结果展示)。
    - 密钥转换界面 (输入公钥、转换密钥、显示结果)。
4.  **测试**：
    - 单元测试：算法正确性。
    - 集成测试：时间窗口边界测试、错误密钥测试、异地部署测试。

## 6. 部署说明

- **硬件要求**：服务器必须配备 TPM 2.0 芯片。
- **软件要求**：Linux/Windows Server，TPM 驱动及 TSS 栈。
- **注意事项**：重新部署服务时，需确保 TPM 状态未被清除，以便复用核心密钥。
