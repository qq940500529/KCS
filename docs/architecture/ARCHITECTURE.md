# KCS 系统架构文档

## 1. 整体架构

KCS (Key Conversion System) 是一个基于 TPM 的安全密钥转换系统，采用前后端分离的架构设计。

```
┌─────────────────────────────────────────────────────────────┐
│                       Web 浏览器                             │
│  ┌─────────────────┐              ┌─────────────────┐       │
│  │  密钥生成界面    │              │  密钥转换界面    │       │
│  └─────────────────┘              └─────────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
                    HTTPS/REST API
                            │
┌─────────────────────────────────────────────────────────────┐
│                      后端服务层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  API 接口层  │  │  业务逻辑层  │  │  数据验证层  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                            │                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  密钥生成    │  │  密钥转换    │  │  时间验证    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                     TPM 2.0 接口
                            │
┌─────────────────────────────────────────────────────────────┐
│                     TPM 硬件层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  核心密钥    │  │  时间/计数器 │  │  加密运算    │      │
│  │   存储      │  │  (防篡改)    │  │   引擎      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 2. 核心模块

### 2.1 前端模块 (Frontend)

**技术栈建议**：React/Vue.js + TypeScript + Tailwind CSS

**主要组件**：
- `KeyGenerationPage`: 密钥生成页面
- `KeyConversionPage`: 密钥转换页面
- `ConfigurationForm`: 参数配置表单
- `ResultDisplay`: 结果展示组件
- `TimeWindowSelector`: 时间窗口选择器
- `KeyValidator`: 密钥格式验证器

### 2.2 后端模块 (Backend)

**技术栈建议**：Python (Flask/FastAPI) 或 Go

**核心子模块**：

#### 2.2.1 TPM 交互模块 (`backend/src/tpm/`)
- `tpm_interface.py`: TPM 基础接口封装
- `core_key_manager.py`: 核心密钥管理
- `time_manager.py`: TPM 时间读取与验证
- `tpm_operations.py`: TPM 加密运算操作

#### 2.2.2 加密算法模块 (`backend/src/crypto/`)
- `key_generator.py`: 私钥随机生成
- `transfer_key_generator.py`: 转换密钥生成
- `public_key_generator.py`: 公钥封装生成
- `key_decryptor.py`: 密钥解密/转换逻辑
- `kdf.py`: 密钥派生函数 (KDF)

#### 2.2.3 API 接口模块 (`backend/src/api/`)
- `routes.py`: API 路由定义
- `handlers.py`: 请求处理器
- `validators.py`: 输入验证
- `responses.py`: 响应格式化

#### 2.2.4 数据模型 (`backend/src/models/`)
- `key_models.py`: 密钥数据模型
- `config_models.py`: 配置数据模型
- `time_models.py`: 时间窗口模型

#### 2.2.5 工具模块 (`backend/src/utils/`)
- `logger.py`: 日志记录
- `error_handler.py`: 错误处理
- `config_loader.py`: 配置加载

## 3. 数据流

### 3.1 密钥生成流程

```
用户输入参数 → 前端验证 → API 请求 → 后端验证 → 
生成私钥 → 生成转换密钥 → 获取 TPM 核心密钥 → 
生成主密钥 (KDF) → 加密私钥 → 生成公钥 → 返回结果
```

### 3.2 密钥转换流程

```
用户输入 (公钥 + 转换密钥) → 前端验证 → API 请求 →
后端验证 → 解析公钥 → URL 验证 → 读取 TPM 时间 →
时间验证 → TPM 参与解密 → KDF 计算 → 还原私钥 → 返回结果
```

## 4. 安全设计

### 4.1 核心密钥保护
- 使用 TPM 的 `TPMA_OBJECT_FIXEDTPM` 属性
- 密钥不可导出，仅在 TPM 内部使用
- 绑定到特定硬件和 URL

### 4.2 时间验证机制
- 完全依赖 TPM 内部时钟
- 时间作为加密参数，而非简单的逻辑判断
- 使用 TPM Policy 或时间签名机制

### 4.3 多重授权
解密需要同时满足：
1. 正确的公钥
2. 正确的转换密钥
3. 正确的服务器（硬件 + URL）
4. 正确的时间窗口

### 4.4 防止攻击
- **离线攻击**：转换密钥不存储，无法暴力破解
- **硬件克隆**：TPM 绑定防止硬件迁移
- **时间篡改**：使用 TPM 时钟，不依赖系统时间
- **中间人攻击**：HTTPS 通信，证书验证

## 5. 接口设计

### 5.1 密钥生成接口

**POST** `/api/v1/keys/generate`

请求体：
```json
{
  "private_key_length": 12,
  "private_key_rules": {
    "uppercase": true,
    "lowercase": true,
    "digits": true,
    "symbols": true
  },
  "transfer_keys_count": 1,
  "time_window": {
    "start": "2024-01-01T00:00:00Z",
    "end": "2024-12-31T23:59:59Z"
  }
}
```

响应：
```json
{
  "success": true,
  "data": {
    "private_key": "aB3$xY9#mK2p",
    "transfer_keys": ["trans-key-1"],
    "public_key": "pub_...encoded...",
    "server_url": "https://kcs.example.com"
  }
}
```

### 5.2 密钥转换接口

**POST** `/api/v1/keys/convert`

请求体：
```json
{
  "public_key": "pub_...encoded...",
  "transfer_keys": ["trans-key-1"]
}
```

响应：
```json
{
  "success": true,
  "data": {
    "private_key": "aB3$xY9#mK2p",
    "time_window": {
      "start": "2024-01-01T00:00:00Z",
      "end": "2024-12-31T23:59:59Z"
    }
  }
}
```

## 6. 扩展性考虑

### 6.1 多密钥支持
- 支持批量生成密钥
- 支持密钥组管理

### 6.2 审计日志
- 记录所有密钥操作
- 支持操作追踪和安全审计

### 6.3 高可用性
- 支持多服务器部署（每个服务器独立 TPM）
- 负载均衡策略

### 6.4 版本兼容
- API 版本管理
- 公钥格式版本支持

## 7. 性能考虑

- TPM 操作相对较慢，需要合理缓存
- 核心密钥句柄复用
- 并发请求限制
- 操作超时设置

## 8. 监控与运维

- 健康检查接口
- TPM 状态监控
- 性能指标收集
- 错误告警机制
