# KCS 系统架构文档

## 1. 整体架构

KCS (Key Conversion System) 是一个基于 TPM 的安全密钥转换系统，采用前后端分离的架构设计。

```
┌─────────────────────────────────────────────────────────────┐
│                       Web 浏览器                             │
│  ┌─────────────────┐              ┌─────────────────┐       │
│  │  密钥生成界面    │              │  密钥转换界面    │       │
│  └─────────────────┘              └─────────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
                    HTTPS/REST API
                            │
┌─────────────────────────────────────────────────────────────┐
│                      后端服务层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  API 接口层  │  │  业务逻辑层  │  │  数据验证层  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                            │                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  密钥生成    │  │  密钥转换    │  │  时间验证    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                     TPM 2.0 接口
                            │
┌─────────────────────────────────────────────────────────────┐
│                     TPM 硬件层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  核心密钥    │  │  时间/计数器 │  │  加密运算    │      │
│  │   存储      │  │  (防篡改)    │  │   引擎      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 2. 核心模块

### 2.1 前端模块 (Frontend)

**技术栈**：React 18+ + TypeScript + Vite

选择理由：
- React 生态成熟，组件丰富，易于开发和维护
- TypeScript 提供类型安全，减少运行时错误
- Vite 构建速度快，开发体验好，配置简单

**主要组件**：
- `KeyGenerationPage`: 密钥生成页面
- `KeyConversionPage`: 密钥转换页面
- `ConfigurationForm`: 参数配置表单
- `ResultDisplay`: 结果展示组件
- `TimeWindowSelector`: 时间窗口选择器
- `KeyValidator`: 密钥格式验证器

### 2.2 后端模块 (Backend)

**技术栈**：Python 3.9+ + FastAPI

选择理由：
- FastAPI 自动生成 OpenAPI 文档，便于 API 调试和集成
- 原生支持异步操作，性能优于 Flask
- 内置数据验证（Pydantic），减少手动验证代码
- 类型提示友好，代码可读性强
- 部署简单（Uvicorn/Gunicorn），支持热重载

**核心子模块**：

#### 2.2.1 TPM 交互模块 (`backend/src/tpm/`)
- `tpm_interface.py`: TPM 基础接口封装
- `core_key_manager.py`: 核心密钥管理
- `time_manager.py`: TPM 时间读取与验证
- `tpm_operations.py`: TPM 加密运算操作

#### 2.2.2 加密算法模块 (`backend/src/crypto/`)
- `key_generator.py`: 私钥随机生成
- `transfer_key_generator.py`: 转换密钥生成
- `public_key_generator.py`: 公钥封装生成
- `key_decryptor.py`: 密钥解密/转换逻辑
- `kdf.py`: 密钥派生函数 (KDF)

#### 2.2.3 API 接口模块 (`backend/src/api/`)
- `routes.py`: API 路由定义
- `handlers.py`: 请求处理器
- `validators.py`: 输入验证
- `responses.py`: 响应格式化

#### 2.2.4 数据模型 (`backend/src/models/`)
- `key_models.py`: 密钥数据模型
- `config_models.py`: 配置数据模型
- `time_models.py`: 时间窗口模型

#### 2.2.5 工具模块 (`backend/src/utils/`)
- `logger.py`: 日志记录（详见日志规范）
- `error_handler.py`: 错误处理
- `config_loader.py`: 配置加载

## 2.3 日志模块规范

**日志框架**：使用 Python 标准库 `logging` + `python-json-logger`

**日志级别和用途**：
- `DEBUG`: 开发调试信息（仅开发环境）
- `INFO`: 正常操作记录（API 调用、系统状态）
- `WARNING`: 警告信息（失败的验证尝试、异常请求）
- `ERROR`: 错误信息（系统错误、TPM 故障）
- `CRITICAL`: 严重错误（系统崩溃、安全事件）

**日志存储内容（允许记录）**：
- ✅ 时间戳
- ✅ 操作类型（生成密钥、转换密钥）
- ✅ 客户端 IP 地址
- ✅ 请求参数（密钥长度、时间窗口配置）
- ✅ 操作结果（成功/失败）
- ✅ 失败原因（时间不匹配、URL 不匹配等）
- ✅ 公钥哈希值（SHA256）
- ✅ TPM 操作耗时
- ✅ 系统性能指标

**严禁记录的敏感信息**：
- ❌ 私钥（Private Key）
- ❌ 转换密钥（Transfer Key）
- ❌ 公钥完整内容（仅记录哈希）
- ❌ 核心密钥句柄详细信息
- ❌ TPM 内部密钥材料
- ❌ 任何可用于恢复私钥的中间值

**日志格式（JSON）**：
```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "level": "INFO",
  "action": "KEY_GENERATION",
  "client_ip": "192.168.1.100",
  "request_params": {
    "key_length": 12,
    "transfer_keys_count": 1,
    "time_window_days": 365
  },
  "result": "success",
  "public_key_hash": "sha256:abc123...",
  "duration_ms": 245
}
```

**日志文件管理**：
- 应用日志：`/var/log/kcs/app.log`
- 审计日志：`/var/log/kcs/audit.log`
- 错误日志：`/var/log/kcs/error.log`
- 日志轮转：每天轮转，保留 30 天
- 日志权限：仅 kcs 用户可读写（chmod 600）

## 3. 数据流

### 3.1 密钥生成流程

```
用户输入参数 → 前端验证 → API 请求 → 后端验证 → 
生成私钥 → 生成多个转换密钥（数量可配置） → 获取 TPM 核心密钥 → 
为每个转换密钥派生子密钥 → 组合所有子密钥生成主密钥 (KDF) → 
加密私钥 → 生成公钥（包含转换密钥数量信息） → 返回结果
```

**多转换密钥机制**：
- 系统支持生成任意数量的转换密钥（至少 1 个，无上限）
- 每个转换密钥独立生成，具有相同的安全强度（256 位）
- 所有转换密钥的哈希值存储在公钥中用于验证
- 解密时必须提供所有转换密钥，**顺序无关**，实现灵活的多重授权机制
- 建议数量：小团队 2-3 个，中型组织 5-10 个，大型组织 10+ 个

### 3.2 密钥转换流程

```
用户输入公钥和所有转换密钥 → 前端验证 → API 请求 → 后端验证 → 
解析公钥 → 验证转换密钥数量 → 验证每个转换密钥哈希 →
地址验证 → 读取 TPM 时间 → 时间验证 → 
为每个转换密钥派生子密钥 → 组合所有子密钥重建主密钥 →
TPM 参与解密 → 还原私钥 → 返回结果
```

**安全验证步骤**：
1. 验证提供的转换密钥数量是否与公钥中记录的数量一致
2. **自动排序处理**：系统对提供的密钥进行排序，确保输入顺序无关
3. 验证每个转换密钥的哈希值是否正确（使用集合比较）
4. 只有所有转换密钥都正确时才能重建主密钥
5. 任何一个转换密钥错误或缺失都会导致解密失败

## 4. 安全设计

### 4.1 核心密钥保护
- 使用 TPM 的 `TPMA_OBJECT_FIXEDTPM` 属性
- 密钥不可导出，仅在 TPM 内部使用
- 绑定到特定硬件和 URL

### 4.2 时间验证机制

**双层防护体系**：

1. **TPM Policy 硬件强制**（推荐）：
   - 使用 PolicyCounterTimer 在 TPM 硬件层强制时间窗口
   - 密钥材料封装在 sealed object，必须满足 policy 才能 unseal
   - 攻击者即使修改应用代码也无法在时间窗外使用密钥
   - 需要真实 TPM 2.0 硬件和正确配置

2. **应用层时间绑定**（辅助）：
   - 依赖 TPM 内部时钟读取
   - 时间窗口参与密钥派生过程
   - 修改公钥中的时间会导致解密失败
   - 但攻击者修改应用代码可绕过时间检查

**安全边界对比**：
| 方案 | 信任边界 | 代码修改攻击 |
|------|---------|------------|
| TPM Policy 强制 | TPM 硬件 | ✅ 不可绕过 |
| 应用层时间绑定 | 应用逻辑 | ⚠️ 可绕过 |

### 4.3 多重授权

解密需要同时满足：
1. 正确的公钥
2. **所有转换密钥都正确**（数量可配置，至少 1 个，必须全部提供且正确）
3. 正确的服务器（硬件 + URL）
4. 正确的时间窗口

**多转换密钥安全优势**：
- ✅ 实现多人授权机制（每人持有一个转换密钥）
- ✅ 灵活配置授权人数（小团队 2-3 人，大组织 10+ 人）
- ✅ **输入顺序无关**：密钥可任意顺序提供，系统自动处理
- ✅ 提高安全性（攻击者需要获取所有转换密钥）
- ✅ 防止单点失败风险（单个密钥持有者无法独自解密）
- ✅ 支持组织授权策略（如 3/5 人员同时授权，可配置不同数量）

### 4.4 防止攻击

| 攻击类型 | 防护措施 | 应用层防护 | TPM Policy 防护 |
|---------|---------|-----------|----------------|
| **离线攻击** | 转换密钥不存储，需全部密钥 | ✅ 有效 | ✅ 有效 |
| **部分密钥泄露** | 需要所有转换密钥 | ✅ 有效 | ✅ 有效 |
| **硬件克隆** | TPM 硬件绑定 | ✅ 有效 | ✅ 有效 |
| **系统时间篡改** | 使用 TPM 时钟 | ✅ 有效 | ✅ 有效 |
| **公钥时间篡改** | 时间参与密钥派生 | ✅ 有效 | ✅ 有效 |
| **应用代码修改** | 时间绑定到派生 | ⚠️ 可绕过 | ✅ 不可绕过 |
| **中间人攻击** | HTTPS 强制加密 | ✅ 有效 | ✅ 有效 |

**关键点**：当威胁模型包含"攻击者获得服务器完全控制权限并可修改代码"时，需要启用 TPM Policy 将信任边界下沉到硬件层。

## 5. 接口设计

### 5.1 密钥生成接口

**POST** `/api/v1/keys/generate`

请求体：
```json
{
  "private_key_length": 12,
  "private_key_rules": {
    "uppercase": true,
    "lowercase": true,
    "digits": true,
    "symbols": true
  },
  "transfer_keys_count": 1,
  "time_window": {
    "start": "2024-01-01T00:00:00Z",
    "end": "2024-12-31T23:59:59Z"
  }
}
```

响应：
```json
{
  "success": true,
  "data": {
    "private_key": "aB3$xY9#mK2p",
    "transfer_keys": ["TK-A8f9e2d1c4b5a6d7e8f9"],
    "public_key": "PUB_eyJ2ZXJzaW9uIjoxLCJkYXRhIjoiLi4uIn0=",
    "server_url": "https://kcs.example.com"
  }
}
```

### 5.2 密钥转换接口

**POST** `/api/v1/keys/convert`

请求体：
```json
{
  "public_key": "PUB_eyJ2ZXJzaW9uIjoxLCJkYXRhIjoiLi4uIn0=",
  "transfer_keys": ["TK-A8f9e2d1c4b5a6d7e8f9"]
}
```

响应：
```json
{
  "success": true,
  "data": {
    "private_key": "aB3$xY9#mK2p",
    "time_window": {
      "start": "2024-01-01T00:00:00Z",
      "end": "2024-12-31T23:59:59Z"
    }
  }
}
```

## 6. 扩展性考虑

### 6.1 多密钥支持
- 支持批量生成密钥
- 支持密钥组管理

### 6.2 审计日志
- 记录所有密钥操作
- 支持操作追踪和安全审计

### 6.3 高可用性
- 支持多服务器部署（每个服务器独立 TPM）
- 负载均衡策略

### 6.4 版本兼容
- API 版本管理
- 公钥格式版本支持

## 7. 性能考虑

- TPM 操作相对较慢，需要合理缓存
- 核心密钥句柄复用
- 并发请求限制
- 操作超时设置

## 8. 监控与运维

- 健康检查接口
- TPM 状态监控
- 性能指标收集
- 错误告警机制
